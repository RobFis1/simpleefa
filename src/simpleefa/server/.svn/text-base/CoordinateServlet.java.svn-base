package simpleefa.server;

import java.io.DataOutputStream;
import java.io.IOException;
import java.io.InputStream;

import java.net.HttpURLConnection;
import java.net.URL;

import javax.servlet.ServletContext;
import javax.servlet.ServletException;
import javax.servlet.ServletOutputStream;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.xml.namespace.QName;
import javax.xml.xquery.XQConnection;
import javax.xml.xquery.XQDataSource;

import javax.xml.xquery.XQPreparedExpression;
import javax.xml.xquery.XQSequence;

import net.sf.saxon.xqj.SaxonXQDataSource;

public class CoordinateServlet extends HttpServlet {

	private static final long serialVersionUID = -4356636877078339046L;
	private final XQDataSource dataSource = new SaxonXQDataSource();


	@Override
	public void doGet(HttpServletRequest request, HttpServletResponse response)
	throws ServletException, IOException {
		
		String efa_url = Simpleefa.EFA_URL;

		if (request.getParameter("efa_url") != null) {
			efa_url = request.getParameter("efa_url");
		}

		ServletContext c = this.getServletContext();

		if (!Simpleefa.checkLimit(request, c)) {
			Simpleefa.limitReached(request, response);			
			return;			
		}

		XQPreparedExpression pEx;
		InputStream input;
		XQConnection conn;

		long x = ensureInt(request.getParameter("x"),0)-Simpleefa.COORD_X_CORRECTION;
		long y = Simpleefa.COORD_Y_CORRECTION - ensureInt(request.getParameter("y"),0);
		long radius = ensureInt(request.getParameter("radius"),0);


		try {

			conn =dataSource.getConnection();

			String data = "";
			data += "coord="+x+":"+y+":NBWT";
			data += "&" + "inclDrawClasses_1=1:2:6";
			data += "&" + "max=-1";
			data += "&" + "purpose=";
			data += "&" + "inclFilter=1";
			data += "&" + "radius_1=" + radius;
			data += "&" + "type_1=STOP";

			System.out.println(data);

			URL url = new URL(efa_url + "XML_COORD_REQUEST");

			HttpURLConnection connection = (HttpURLConnection)url.openConnection();
			connection.setRequestMethod("POST");
			connection.setRequestProperty("Content-Type", "application/x-www-form-urlencoded");
			connection.setRequestProperty("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8");
			connection.setRequestProperty("Connection", "keep-alive");
			connection.setRequestProperty("Host", "www.efa-bw.de");
			connection.setRequestProperty("Connection", "keep-alive");
			connection.setRequestProperty("User-Agent", "Mozilla/5.0 (Ubuntu; X11; Linux i686; rv:9.0.1) Gecko/20100101 Firefox/9.0.1");
			connection.setRequestProperty("Content-Length", "" + Integer.toString(data.getBytes().length));
			connection.setRequestProperty("Referer", "http://www.efa-bw.de/nvbw/XML_COORD_REQUEST");


			connection.setUseCaches(false);
			connection.setDoInput(true);
			connection.setDoOutput(true);

			DataOutputStream wr = new DataOutputStream (connection.getOutputStream ());
			wr.writeBytes(data);
			wr.flush();
			wr.close();


			input = connection.getInputStream();

			response.setContentType("text/xml");

			String xquery = "declare namespace functx = 'http://www.functx.com';"+ 
			"declare function functx:trim($arg as xs:string? ) as xs:string {"+
			"	fn:replace(fn:replace($arg,'(\\s|[ ]|[,.!:;]|[n][b][s][p][;])+$',''),'^(\\s|[ ]|[,.!:;]|[n][b][s][p][;])+','')"+
			"};" +
			"declare function functx:repeat-string($stringToRepeat as xs:string?,$count as xs:integer) as xs:string { " +
			"	string-join((for $i in 1 to $count return $stringToRepeat),'')" +
			"};" +
			"declare function functx:pad-integer-to-length ($integerToPad as xs:anyAtomicType?,$length as xs:integer )  as xs:string {" +
			"	if ($length < string-length(string($integerToPad)))" +
			"	then error(xs:QName('functx:Integer_Longer_Than_Length'))" +
			"	else concat" +
			"		(functx:repeat-string(" +
			"			'0',$length - string-length(string($integerToPad)))," +
			"		string($integerToPad))" +
			"	} ;" +
			"declare function functx:time ($hour as xs:anyAtomicType,$minute as xs:anyAtomicType,$second as xs:anyAtomicType)  as xs:time {"+
			" xs:time("+
			"  concat("+
			"    functx:pad-integer-to-length(xs:integer($hour),2),':',"+
			"    functx:pad-integer-to-length(xs:integer($minute),2),':'," +
			"	 functx:pad-integer-to-length(xs:integer($second),2)))"+
			"} ;"+
			"declare variable $doc external;"+
			"for $req in $doc//itdCoordInfoRequest " +
			"let $x := data($req/itdCoordInfo/coordInfoRequest/itdCoord/@x)" +
			"let $y := data($req/itdCoordInfo/coordInfoRequest/itdCoord/@y)" +
			" return" +
			" <nearby_stations> " +
			"<for_input>" +
			"	<x>{$x}</x>" +
			"	<y>{$y}</y>" +
			"</for_input>" +
			"{" +
			" " +
			" for $loc in $req/itdCoordInfo/coordInfoItemList/coordInfoItem " +
			"	let $id := data($loc/@id)" +
			"	let $x := number($loc/itdPathCoordinates/itdCoordinateBaseElemList/itdCoordinateBaseElem/x/child::text())" +
			"	let $y := number($loc/itdPathCoordinates/itdCoordinateBaseElemList/itdCoordinateBaseElem/y/child::text())" +
			"	let $stationname := data($loc/@name)" +
			"	let $locationname := data($loc/@locality)" +
			"	let $name := concat($locationname,', ',$stationname)" +
			"	return " +
			"		<station id='{$id}'>" +
			"			{$name}" +
			"			<location_name>" +
			"				{$locationname}" +
			"			</location_name>" +
			"			<station_name>" +
			"				{$stationname}" +
			"			</station_name>" +
			"			<position x='{xs:decimal($x + " + Simpleefa.COORD_X_CORRECTION + ")}' y='{xs:decimal(" + Simpleefa.COORD_Y_CORRECTION + "-$y)}' />" +
			"		</station>" +
			"}" +
			"</nearby_stations>";


			pEx = conn.prepareExpression(xquery);

			pEx.bindDocument(new QName("doc"), input, null,null);


			ServletOutputStream out = response.getOutputStream();

			out.println("<?xml version=\"1.0\"?>");

			XQSequence result = pEx.executeQuery();
			result.writeSequence(out, null);	

			result.close();
			pEx.close();

			conn.close();
			out.close();
			input.close();
			connection.disconnect();

			System.gc();

		} catch (Exception e) {
			e.printStackTrace();
		}


	}


	private int ensureInt(String cand, int sonst) {
		try{
			sonst = Integer.parseInt(cand);
		}catch(Exception e){

		}
		return sonst;
	}
}
